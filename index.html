<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>FVG Trading Bot</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: #fff; min-height: 100vh; }
        .container { max-width: 500px; margin: 0 auto; padding: 10px; }
        
        .header { background: rgba(30, 41, 59, 0.5); padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #334155; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .header-title { display: flex; align-items: center; gap: 10px; }
        .icon { width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .title { font-size: 18px; font-weight: bold; }
        .subtitle { font-size: 12px; color: #94a3b8; margin-top: 2px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .btn-settings { background: rgba(51, 65, 85, 0.5); color: #cbd5e1; width: 40px; height: 40px; padding: 0; }
        .btn-start { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .btn-stop { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .btn-primary { background: rgba(59, 130, 246, 0.2); color: #3b82f6; width: 100%; margin-top: 10px; }
        
        .card { background: rgba(30, 41, 59, 0.5); border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid #334155; }
        
        .status-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .status-info { display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #475569; }
        .status-dot.active { background: #22c55e; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .stat { background: rgba(51, 65, 85, 0.3); padding: 12px; border-radius: 10px; text-align: center; }
        .stat.bullish { background: rgba(34, 197, 94, 0.1); }
        .stat.bearish { background: rgba(239, 68, 68, 0.1); }
        .stat-value { font-size: 24px; font-weight: bold; }
        .stat.bullish .stat-value { color: #22c55e; }
        .stat.bearish .stat-value { color: #ef4444; }
        .stat-label { font-size: 11px; color: #94a3b8; margin-top: 5px; }
        
        .config { display: none; }
        .config.show { display: block; }
        .form-group { margin-bottom: 12px; }
        .form-label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 5px; }
        .form-input, .form-select { width: 100%; padding: 10px; background: rgba(51, 65, 85, 0.5); border: 1px solid #475569; border-radius: 8px; color: #fff; font-size: 14px; }
        
        .signal { background: rgba(34, 197, 94, 0.05); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 12px; padding: 12px; margin-bottom: 10px; }
        .signal.bearish { background: rgba(239, 68, 68, 0.05); border-color: rgba(239, 68, 68, 0.2); }
        .signal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .signal-type { font-weight: bold; color: #22c55e; }
        .signal.bearish .signal-type { color: #ef4444; }
        .signal-time { font-size: 11px; color: #64748b; }
        .signal-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 12px; }
        .signal-item-label { color: #64748b; }
        .signal-item-value { font-weight: bold; color: #fff; }
        .signal-item-value.green { color: #22c55e; }
        .signal-item-value.red { color: #ef4444; }
        .signal-item-value.blue { color: #3b82f6; }
        
        .empty { text-align: center; padding: 40px 20px; color: #64748b; }
        .last-check { text-align: center; font-size: 11px; color: #475569; margin-top: 10px; }
        
        .snooze-btn { 
            position: fixed; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: #ef4444; 
            color: white; 
            padding: 15px 40px; 
            border-radius: 50px; 
            font-size: 18px; 
            font-weight: bold; 
            border: none; 
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4);
            z-index: 1000;
            animation: bounce 0.5s infinite;
            cursor: pointer;
        }
        @keyframes bounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Mobile Check Warning -->
        <div id="webWarning" class="card hidden" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3);">
            <h3 style="color: #ef4444; margin-bottom: 10px;">‚ö†Ô∏è Desktop Browser Detected</h3>
            <p style="color: #fca5a5; font-size: 14px; line-height: 1.5;">
                This trading bot is designed to work as a mobile app only. Please install it using AppsGeyser or open it on your mobile device for full functionality.
            </p>
        </div>

        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <div class="header-title">
                    <div class="icon">üìä</div>
                    <div>
                        <div class="title">FVG Trading Bot</div>
                        <div class="subtitle" id="symbolDisplay">BTC/USDT ‚Ä¢ 15m</div>
                        <div class="subtitle" id="deviceStatus" style="font-size: 10px; color: #10b981;"></div>
                    </div>
                </div>
                <button class="btn btn-settings" id="settingsBtn">‚öôÔ∏è</button>
            </div>
        </div>

        <!-- Status Card -->
        <div class="card">
            <div class="status-row">
                <div class="status-info">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Stopped</span>
                </div>
                <button class="btn btn-start" id="toggleBtn">Start Bot</button>
            </div>
            
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="totalSignals">0</div>
                    <div class="stat-label">Total Signals</div>
                </div>
                <div class="stat bullish">
                    <div class="stat-value" id="bullishSignals">0</div>
                    <div class="stat-label">Bullish</div>
                </div>
                <div class="stat bearish">
                    <div class="stat-value" id="bearishSignals">0</div>
                    <div class="stat-label">Bearish</div>
                </div>
            </div>

            <div id="zoneStatus"></div>

            <div class="last-check" id="lastCheck"></div>
        </div>

        <!-- Configuration -->
        <div class="card config" id="configPanel">
            <h3 style="margin-bottom: 15px;">Configuration</h3>
            
            <div class="form-group">
                <label class="form-label">Trading Pair</label>
                <select class="form-select" id="symbolInput">
                    <option value="BTCUSDT">BTC/USDT</option>
                    <option value="ETHUSDT">ETH/USDT</option>
                    <option value="BNBUSDT">BNB/USDT</option>
                    <option value="SOLUSDT">SOL/USDT</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Timeframe</label>
                <select class="form-select" id="timeframeInput">
                    <option value="1m">1 Minute</option>
                    <option value="5m">5 Minutes</option>
                    <option value="15m">15 Minutes</option>
                    <option value="30m">30 Minutes</option>
                    <option value="1h">1 Hour</option>
                    <option value="4h">4 Hours</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Check Interval (seconds)</label>
                <input type="number" class="form-input" id="intervalInput" value="60" min="10">
            </div>

            <div class="form-group">
                <label class="form-label">Discord Webhook URL</label>
                <input type="text" class="form-input" id="webhookInput" placeholder="https://discord.com/api/webhooks/...">
            </div>

            <div style="border-top: 1px solid #475569; margin: 15px 0; padding-top: 15px;">
                <h4 style="color: #cbd5e1; font-size: 14px; margin-bottom: 10px;">üìç Zone Filter (Optional)</h4>
                
                <div class="form-group">
                    <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="useZoneInput" style="width: auto;">
                        Enable Zone Filter
                    </label>
                </div>

                <div class="form-group">
                    <label class="form-label">Upper Zone Price</label>
                    <input type="number" class="form-input" id="zoneUpperInput" placeholder="e.g., 45000" step="0.01">
                </div>

                <div class="form-group">
                    <label class="form-label">Lower Zone Price</label>
                    <input type="number" class="form-input" id="zoneLowerInput" placeholder="e.g., 44000" step="0.01">
                </div>

                <p style="font-size: 11px; color: #64748b; margin-top: 5px;">
                    ‚ÑπÔ∏è <strong>How it works:</strong><br>
                    1Ô∏è‚É£ Price enters zone ‚Üí Zone becomes active<br>
                    2Ô∏è‚É£ 15m FVG forms ‚Üí Ready for signals<br>
                    3Ô∏è‚É£ Signals generate while conditions met<br>
                    4Ô∏è‚É£ <strong>15m candle closes outside zone ‚Üí Zone permanently deleted</strong>
                </p>
            </div>

            <div class="form-group">
                <label class="form-label">Alarm Sound</label>
                <select class="form-select" id="alarmInput">
                    <option value="beep">Beep</option>
                    <option value="bell">Bell</option>
                    <option value="chime">Chime</option>
                    <option value="alert">Alert</option>
                    <option value="none">No Alarm</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Alarm Duration (seconds)</label>
                <input type="number" class="form-input" id="durationInput" value="3" min="1" max="10">
            </div>

            <div class="form-group">
                <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="snoozeInput" style="width: auto;">
                    Enable Snooze Button
                </label>
            </div>

            <div class="form-group">
                <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="wakeLockInput" style="width: auto;">
                    Keep Screen On
                </label>
            </div>

            <div class="form-group">
                <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="notificationInput" style="width: auto;">
                    Show Notifications
                </label>
            </div>

            <button class="btn btn-primary" id="saveConfigBtn">Save & Close</button>
        </div>

        <!-- Signals -->
        <div class="card">
            <h3 style="margin-bottom: 15px;">Recent Signals</h3>
            <div id="signalsList">
                <div class="empty">No signals yet. Start the bot to receive trading signals.</div>
            </div>
        </div>
    </div>

    <button id="snoozeBtn" class="snooze-btn hidden">üîï SNOOZE ALARM</button>

    <script>
        // Bot configuration
        let bot = {
            isRunning: false,
            symbol: 'BTCUSDT',
            timeframe: '15m',
            interval: 60,
            webhook: '',
            alarmSound: 'beep',
            alarmDuration: 3,
            snoozeEnabled: true,
            keepScreenOn: false,
            showNotifications: true,
            useZone: false,
            zoneUpper: null,
            zoneLower: null,
            zoneTapped: false,
            last15mFVG: null,
            wakeLock: null,
            signals: [],
            stats: { total: 0, bullish: 0, bearish: 0, lastCheck: null },
            sentSignals: new Set(),
            usedSwings: new Set(),
            intervalId: null,
            audioContext: null,
            activeOscillators: []
        };

        // Mobile detection
        function isMobileDevice() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            const isAppsGeyser = /AppsGeyser|wv|Android.*AppsGeyser/i.test(userAgent);
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
            const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent.toLowerCase());
            return isAppsGeyser || isStandalone || isMobile;
        }

        function isDesktopBrowser() {
            const userAgent = navigator.userAgent.toLowerCase();
            return !isMobileDevice() && 
                   (userAgent.indexOf('win') > -1 || 
                    userAgent.indexOf('mac') > -1 || 
                    userAgent.indexOf('linux') > -1) &&
                   userAgent.indexOf('mobile') === -1;
        }

        // Load saved configuration
        function loadConfig() {
            const saved = localStorage.getItem('tradingBotData');
            if (saved) {
                const data = JSON.parse(saved);
                bot = { ...bot, ...data };
                bot.sentSignals = new Set(data.sentSignals || []);
                bot.usedSwings = new Set(data.usedSwings || []);
            }
            
            document.getElementById('symbolInput').value = bot.symbol;
            document.getElementById('timeframeInput').value = bot.timeframe;
            document.getElementById('intervalInput').value = bot.interval;
            document.getElementById('webhookInput').value = bot.webhook;
            document.getElementById('alarmInput').value = bot.alarmSound || 'beep';
            document.getElementById('durationInput').value = bot.alarmDuration || 3;
            document.getElementById('snoozeInput').checked = bot.snoozeEnabled !== false;
            document.getElementById('wakeLockInput').checked = bot.keepScreenOn || false;
            document.getElementById('notificationInput').checked = bot.showNotifications !== false;
            document.getElementById('useZoneInput').checked = bot.useZone || false;
            document.getElementById('zoneUpperInput').value = bot.zoneUpper || '';
            document.getElementById('zoneLowerInput').value = bot.zoneLower || '';
            
            updateDisplay();
        }

        // Save configuration
        function saveConfig() {
            bot.symbol = document.getElementById('symbolInput').value;
            bot.timeframe = document.getElementById('timeframeInput').value;
            bot.interval = parseInt(document.getElementById('intervalInput').value) || 60;
            bot.webhook = document.getElementById('webhookInput').value;
            bot.alarmSound = document.getElementById('alarmInput').value;
            bot.alarmDuration = parseInt(document.getElementById('durationInput').value) || 3;
            bot.snoozeEnabled = document.getElementById('snoozeInput').checked;
            bot.keepScreenOn = document.getElementById('wakeLockInput').checked;
            bot.showNotifications = document.getElementById('notificationInput').checked;
            bot.useZone = document.getElementById('useZoneInput').checked;
            bot.zoneUpper = parseFloat(document.getElementById('zoneUpperInput').value) || null;
            bot.zoneLower = parseFloat(document.getElementById('zoneLowerInput').value) || null;
            
            if (bot.keepScreenOn && bot.isRunning) {
                requestWakeLock();
            } else {
                releaseWakeLock();
            }
            
            const data = {
                symbol: bot.symbol,
                timeframe: bot.timeframe,
                interval: bot.interval,
                webhook: bot.webhook,
                alarmSound: bot.alarmSound,
                alarmDuration: bot.alarmDuration,
                snoozeEnabled: bot.snoozeEnabled,
                keepScreenOn: bot.keepScreenOn,
                showNotifications: bot.showNotifications,
                useZone: bot.useZone,
                zoneUpper: bot.zoneUpper,
                zoneLower: bot.zoneLower,
                signals: bot.signals,
                stats: bot.stats,
                sentSignals: Array.from(bot.sentSignals),
                usedSwings: Array.from(bot.usedSwings)
            };
            localStorage.setItem('tradingBotData', JSON.stringify(data));
            updateDisplay();
        }

        // Toggle configuration panel
        function toggleConfig() {
            const panel = document.getElementById('configPanel');
            panel.classList.toggle('show');
        }

        // Toggle bot on/off
        function toggleBot() {
            if (!bot.webhook) {
                alert('Please configure Discord Webhook URL first!');
                toggleConfig();
                return;
            }
            
            if (isDesktopBrowser() && !bot.isRunning) {
                const confirmStart = confirm(
                    '‚ö†Ô∏è Desktop Browser Detected\n\n' +
                    'This app is optimized for mobile devices. Background running and wake lock features will not work on desktop browsers.\n\n' +
                    'Do you still want to start the bot?'
                );
                if (!confirmStart) return;
            }
            
            if (bot.isRunning) {
                stopBot();
            } else {
                startBot();
            }
        }

        // Start bot
        function startBot() {
            if (isMobileDevice() && bot.showNotifications && 'Notification' in window) {
                if (Notification.permission === 'default') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            console.log('‚úÖ Notification permission granted');
                        }
                    });
                }
            }
            
            bot.isRunning = true;
            document.getElementById('statusDot').classList.add('active');
            document.getElementById('statusText').textContent = 'Running';
            document.getElementById('toggleBtn').textContent = 'Stop Bot';
            document.getElementById('toggleBtn').className = 'btn btn-stop';
            
            if (bot.keepScreenOn && isMobileDevice()) {
                requestWakeLock();
            }
            
            checkMarket();
            bot.intervalId = setInterval(checkMarket, bot.interval * 1000);
        }

        // Stop bot
        function stopBot() {
            bot.isRunning = false;
            document.getElementById('statusDot').classList.remove('active');
            document.getElementById('statusText').textContent = 'Stopped';
            document.getElementById('toggleBtn').textContent = 'Start Bot';
            document.getElementById('toggleBtn').className = 'btn btn-start';
            
            releaseWakeLock();
            
            if (bot.intervalId) {
                clearInterval(bot.intervalId);
                bot.intervalId = null;
            }
        }

        // Wake lock functions
        async function requestWakeLock() {
            if (!isMobileDevice()) {
                console.warn('Wake lock is only available on mobile devices');
                return;
            }
            
            try {
                if ('wakeLock' in navigator) {
                    bot.wakeLock = await navigator.wakeLock.request('screen');
                    console.log('‚úÖ Wake lock activated');
                    
                    bot.wakeLock.addEventListener('release', () => {
                        console.log('Wake lock released');
                    });
                }
            } catch (error) {
                console.error('Wake lock error:', error);
            }
        }

        function releaseWakeLock() {
            if (bot.wakeLock) {
                bot.wakeLock.release();
                bot.wakeLock = null;
            }
        }

        // Market check function
        async function checkMarket() {
            document.getElementById('lastCheck').textContent = 'Last check: ' + new Date().toLocaleTimeString();
            
            try {
                const candles = await fetchCandles();
                if (!candles || candles.length < 5) return;

                const currentTime = Date.now();
                const lastCandleTime = candles[candles.length - 1][0];
                const timeframeMs = {
                    '1m': 60000, '5m': 300000, '15m': 900000,
                    '30m': 1800000, '1h': 3600000, '4h': 14400000
                };
                const tfMs = timeframeMs[bot.timeframe] || 900000;

                const completedCandles = currentTime - lastCandleTime < tfMs 
                    ? candles.slice(0, -1)
                    : candles;

                if (completedCandles.length < 5) return;

                const currentPrice = completedCandles[completedCandles.length - 1][4];
                let allowSignal = true;

                if (bot.useZone && bot.zoneUpper && bot.zoneLower) {
                    const candles15m = await fetch15mCandles();
                    if (candles15m && candles15m.length >= 2) {
                        const last15mClose = candles15m[candles15m.length - 2][4];
                        
                        if (last15mClose > bot.zoneUpper || last15mClose < bot.zoneLower) {
                            if (bot.zoneTapped) {
                                console.log('‚ùå 15m candle closed outside zone - Zone permanently deleted');
                            }
                            bot.zoneTapped = false;
                            bot.last15mFVG = null;
                            allowSignal = false;
                            saveConfig();
                            updateDisplay();
                            return;
                        }
                    }
                    
                    if (currentPrice > bot.zoneUpper || currentPrice < bot.zoneLower) {
                        allowSignal = false;
                    } else {
                        if (!bot.zoneTapped) {
                            bot.zoneTapped = true;
                            console.log('‚úì Price entered zone:', currentPrice);
                        }

                        if (candles15m && candles15m.length >= 5) {
                            const fvg15m = detectFVGOn15m(candles15m);
                            
                            if (fvg15m) {
                                if (isFVGBroken(candles15m, fvg15m)) {
                                    bot.last15mFVG = null;
                                } else {
                                    if (!bot.last15mFVG || fvg15m.timestamp !== bot.last15mFVG.timestamp) {
                                        bot.last15mFVG = fvg15m;
                                        console.log('‚úì New 15m FVG detected:', fvg15m.type);
                                    }
                                }
                            }
                        }

                        if (!bot.last15mFVG) {
                            allowSignal = false;
                        }
                    }
                }

                if (!allowSignal) {
                    saveConfig();
                    updateDisplay();
                    return;
                }

                const fvgs = detectFVG(completedCandles);
                if (fvgs.length === 0) return;

                const latestFvg = fvgs[fvgs.length - 1];
                const swing = detectSwing(completedCandles, latestFvg);
                
                if (!swing) return;

                const swingKey = swing.timestampStart + '_' + swing.timestampMid;
                const signalKey = latestFvg.type + '_' + latestFvg.timestamp + '_' + swing.timestampMid;

                if (bot.usedSwings.has(swingKey) || bot.sentSignals.has(signalKey)) return;

                const signalData = calculateSignal(latestFvg, swing, currentPrice);
                
                await sendToDiscord(signalData);
                playAlarm();
                showNotification(signalData);
                
                bot.sentSignals.add(signalKey);
                bot.usedSwings.add(swingKey);
                
                const signal = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    zoneFiltered: bot.useZone,
                    ...signalData
                };
                
                bot.signals.unshift(signal);
                bot.signals = bot.signals.slice(0, 20);
                bot.stats.total++;
                if (latestFvg.type === 'bullish') bot.stats.bullish++;
                else bot.stats.bearish++;
                
                saveConfig();
                updateDisplay();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // API functions
        async function fetchCandles() {
            const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${bot.symbol}&interval=${bot.timeframe}&limit=100`);
            const data = await response.json();
            return data.map(c => [parseInt(c[0]), parseFloat(c[1]), parseFloat(c[2]), parseFloat(c[3]), parseFloat(c[4])]);
        }

        async function fetch15mCandles() {
            try {
                const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${bot.symbol}&interval=15m&limit=20`);
                const data = await response.json();
                return data.map(c => [parseInt(c[0]), parseFloat(c[1]), parseFloat(c[2]), parseFloat(c[3]), parseFloat(c[4])]);
            } catch (error) {
                return null;
            }
        }

        function detectFVGOn15m(candles) {
            if (candles.length < 4) return null;
            
            const c3 = candles[candles.length - 4];
            const c2 = candles[candles.length - 3];
            const c1 = candles[candles.length - 2];
            
            if (c1[3] > c3[2]) {
                return { type: 'bullish', top: c1[3], bottom: c3[2], timestamp: c1[0] };
            }
            
            if (c1[2] < c3[3]) {
                return { type: 'bearish', top: c3[3], bottom: c1[2], timestamp: c1[0] };
            }
            
            return null;
        }

        function isFVGBroken(candles, fvg) {
            const recentCandles = candles.slice(-5);
            
            for (let candle of recentCandles) {
                const close = candle[4];
                if (fvg.type === 'bullish') {
                    if (close < fvg.bottom) return true;
                } else {
                    if (close > fvg.top) return true;
                }
